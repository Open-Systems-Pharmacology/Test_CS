name: Signing Wix Bundle
on: [push, workflow_dispatch]

env:
  WIX: "C:/Program Files (x86)/WiX Toolset v3.14"
  SIGNABLE_APP_FILE_PATH: OSPSuite-Full.12.1.136.exe

permissions:
  contents: read
  packages: read
  
jobs:
  sign-app-file:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: download setup
        run: |
          Invoke-WebRequest -OutFile ${{ env.SIGNABLE_APP_FILE_PATH }} "https://github.com/Open-Systems-Pharmacology/Suite/releases/download/v12.1/OSPSuite-Full.12.1.136.exe"

      - name: Pre-sign diagnostics
        shell: pwsh
        run: |
          Get-FileHash "$Env:SIGNABLE_APP_FILE_PATH" -Algorithm SHA256
          $sig = Get-AuthenticodeSignature "$Env:SIGNABLE_APP_FILE_PATH"
          Write-Host "Pre-sign signature status: $($sig.Status)"

      - name: Extract Wix Burn Engine
        shell: cmd
        run: |
          insignia -ib %SIGNABLE_APP_FILE_PATH% -o burnengine.exe

      - name: Sign Wix burn engine with CodeSignTool
        uses: Open-Systems-Pharmacology/Workflows/.github/actions/codesigner-SSL@main
        env:
          ES_USERNAME: ${{ secrets.ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
          ES_CREDENTIAL_ID: ${{ secrets.ES_CREDENTIAL_ID }}
          ES_TOTP_SECRET: ${{ secrets.ES_TOTP_SECRET }}
        with:
          file_path: ./burnengine.exe

      - name: Reattach signed Wix Burn engine to Bundle
        shell: cmd
        run: |
          rename %SIGNABLE_APP_FILE_PATH% original_%SIGNABLE_APP_FILE_PATH%
          insignia -ab burnengine.exe original_%SIGNABLE_APP_FILE_PATH% -o %SIGNABLE_APP_FILE_PATH%
          del original_%SIGNABLE_APP_FILE_PATH%

      - name: Sign Suite Setup with CodeSignTool
        uses: Open-Systems-Pharmacology/Workflows/.github/actions/codesigner-SSL@main
        env:
          ES_USERNAME: ${{ secrets.ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
          ES_CREDENTIAL_ID: ${{ secrets.ES_CREDENTIAL_ID }}
          ES_TOTP_SECRET: ${{ secrets.ES_TOTP_SECRET }}
        with:
          file_path: ./${{env.SIGNABLE_APP_FILE_PATH}}
          #file_path: ./output/OSPSuite-Full.${{env.APP_VERSION}}.exe

      - name: Post-sign verification (signature and container)
        shell: pwsh
        run: |
          $base = 'C:\Program Files (x86)\Windows Kits\10\bin'
          $preferred = @('10.0.22621.0','10.0.22000.0','10.0.19041.0','10.0.17763.0','10.0.26100.0')
          $path = $null
          foreach ($v in $preferred) {
            $candidate = Join-Path $base "$v\x64\signtool.exe"
            if (Test-Path $candidate) { $path = $candidate; break }
          }
          if (-not $path) {
            $found = Get-ChildItem -Directory $base | Sort-Object Name -Descending | ForEach-Object { Join-Path $_.FullName 'x64\signtool.exe' } | Where-Object { Test-Path $_ } | Select-Object -First 1
            $path = $found
          }
          if (-not $path) { throw "SignTool not found." }
          "SIGNSDK=$path" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using signtool: $path"        
          & "$Env:SIGNSDK" verify /pa /all /v "$Env:SIGNABLE_APP_FILE_PATH"
          # Validate attached container is intact
          $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe"
          if (-not (Test-Path $insignia)) { $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe" }
          & "$insignia" -ib "$Env:SIGNABLE_APP_FILE_PATH" -o payload.cab
          if (-not (Test-Path 'payload.cab')) { throw "Attached container extraction failed after signing." }
          Remove-Item payload.cab

      - name: Upload signed setup
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.SIGNABLE_APP_FILE_PATH }}
          path: ${{ env.SIGNABLE_APP_FILE_PATH }}

