name: Signing CKA 2

on: [push, workflow_dispatch]

env:
  MASTER_KEY: master.key
  SIGNABLE_APP_FILE_PATH: OSPSuite-Full.12.1.136.exe
  INSTALL_DIR: C:\Users\runneradmin\eSignerCKA
  MASTER_KEY_FILE: C:\Users\runneradmin\eSignerCKA\master.key

jobs:
  sign-app-file:
    runs-on: windows-latest
    name: Sign APP File with eSignerCKA
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: download setup
        run: |
          Invoke-WebRequest -OutFile OSPSuite-Full.12.1.136.exe "https://github.com/Open-Systems-Pharmacology/Suite/releases/download/v12.1/OSPSuite-Full.12.1.136.exe"

      - name: Download and Unzip eSignerCKA Setup
        run: |
          Invoke-WebRequest -OutFile eSigner_CKA_Setup.zip "https://github.com/SSLcom/eSignerCKA/releases/download/v1.0.7/SSL.COM-eSigner-CKA_1.0.7.zip"
          Expand-Archive -Force eSigner_CKA_Setup.zip
          Remove-Item eSigner_CKA_Setup.zip
          Move-Item -Destination "eSigner_CKA_Installer.exe" -Path "eSigner_CKA_*\*.exe"

      - name: Setup eSignerCKA in Silent Mode
        run: |
          New-Item -ItemType Directory -Force -Path ${{ env.INSTALL_DIR }}
          Start-Process ".\eSigner_CKA_Installer.exe" -argumentlist '/CURRENTUSER /VERYSILENT /SUPPRESSMSGBOXES /DIR="${{ env.INSTALL_DIR }}"' -wait
          ${{ env.INSTALL_DIR }}/RegisterKSP.exe | Out-Null
          ${{ env.INSTALL_DIR }}/eSignerCSP.Config.exe | Out-Null

      - name: Config Account Information on eSignerCKA
        shell: pwsh
        env:
          ES_USERNAME: ${{ secrets.ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
          ES_TOTP_SECRET: ${{ secrets.ES_TOTP_SECRET }}
        run: |
          $exe = Join-Path $Env:INSTALL_DIR 'eSignerCKATool.exe'
          $args = @(
            'config'
            '-mode'; 'product'
            '-user'; $Env:ES_USERNAME
            '-pass'; $Env:ES_PASSWORD
            '-totp'; $Env:ES_TOTP_SECRET
            '-key'; $Env:MASTER_KEY_FILE
            '-r'
          )
          & $exe @args

      - name: Load Certificate into Windows Store
        run: |
          ${{ env.INSTALL_DIR }}/eSignerCKATool.exe unload
          ${{ env.INSTALL_DIR }}/eSignerCKATool.exe load

      - name: Select Certificate From Windows Store
        run: |
          $CodeSigningCert = Get-ChildItem Cert:\CurrentUser\My -CodeSigningCert | WHERE { $_.subject -Match "Life Sciences Foundation gUG" }
          echo "THUMBPRINT=$($CodeSigningCert.Thumbprint)" >> $env:GITHUB_ENV
    
      - name: Debug Certificate List
        run: |
          Get-ChildItem Cert:\CurrentUser\My | Format-List Subject,Thumbprint,EnhancedKeyUsageList

      - name: Resolve stable SignTool path
        id: signtool
        shell: pwsh
        run: |
          $base = 'C:\Program Files (x86)\Windows Kits\10\bin'
          $preferred = @('10.0.22621.0','10.0.22000.0','10.0.19041.0','10.0.17763.0','10.0.26100.0')
          $path = $null
          foreach ($v in $preferred) {
            $candidate = Join-Path $base "$v\x64\signtool.exe"
            if (Test-Path $candidate) { $path = $candidate; break }
          }
          if (-not $path) {
            $found = Get-ChildItem -Directory $base | Sort-Object Name -Descending | ForEach-Object { Join-Path $_.FullName 'x64\signtool.exe' } | Where-Object { Test-Path $_ } | Select-Object -First 1
            $path = $found
          }
          if (-not $path) { throw "SignTool not found." }
          "SIGNSDK=$path" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using signtool: $path"

      - name: Pre-sign diagnostics
        shell: pwsh
        run: |
          Get-FileHash "$Env:SIGNABLE_APP_FILE_PATH" -Algorithm SHA256
          $sig = Get-AuthenticodeSignature "$Env:SIGNABLE_APP_FILE_PATH"
          Write-Host "Pre-sign signature status: $($sig.Status)"

      - name: Sign bundle (append if already signed)
        shell: pwsh
        env:
          THUMBPRINT: ${{ env.THUMBPRINT }}
        run: |
          $file = "$Env:SIGNABLE_APP_FILE_PATH"
          $sig = Get-AuthenticodeSignature $file
          $args = @('sign','/debug','/fd','sha256','/tr','http://ts.ssl.com','/td','sha256','/sha1',"$Env:THUMBPRINT", "$file")
          if ($sig.Status -eq 'Valid') { $args = @('sign','/as','/debug','/fd','sha256','/tr','http://ts.ssl.com','/td','sha256','/sha1',"$Env:THUMBPRINT", "$file") }
          & "$Env:SIGNSDK" @args

      - name: Validate setup
        shell: cmd
        run: |
          ${{ env.SIGNABLE_APP_FILE_PATH }} /layout . /log layout.log

      - name: Post-sign verification (signature and container)
        shell: pwsh
        run: |
          & "$Env:SIGNSDK" verify /pa /all /v "$Env:SIGNABLE_APP_FILE_PATH"
          # Validate attached container is intact
          $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe"
          if (-not (Test-Path $insignia)) { $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe" }
          & "$insignia" -ib "$Env:SIGNABLE_APP_FILE_PATH" -o payload.cab
          if (-not (Test-Path 'payload.cab')) { throw "Attached container extraction failed after signing." }
          Remove-Item payload.cab

      - name: Upload signed setup
        uses: actions/upload-artifact@v5
        with:
          name: OSPSuite-Full.12.1.136
          path: OSPSuite-Full.12.1.136.exe

      - name: Upload eSignerCKA Logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v5
        with:
          name: eSignerCKA-Logs-APP
          path: C:\Users\runneradmin\AppData\Roaming\eSignerCKA\KSP