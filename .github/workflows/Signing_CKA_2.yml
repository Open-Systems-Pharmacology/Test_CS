# Sign Artifact (hardened)
name: Signing CKA 2

on: [push, workflow_dispatch]

env:
  MASTER_KEY: master.key
  SIGNABLE_APP_FILE_PATH: OSPSuite-Full.12.1.136.exe
  INSTALL_DIR: C:\Users\runneradmin\eSignerCKA
  MASTER_KEY_FILE: C:\Users\runneradmin\eSignerCKA\master.key

jobs:
  sign-app-file:
    runs-on: windows-latest
    name: Sign APP File with eSignerCKA
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Download setup
        run: |
          Invoke-WebRequest -OutFile "$Env:SIGNABLE_APP_FILE_PATH" "https://github.com/Open-Systems-Pharmacology/Suite/releases/download/v12.1/OSPSuite-Full.12.1.136.exe"

      - name: Download and Unzip eSignerCKA Setup
        run: |
          Invoke-WebRequest -OutFile eSigner_CKA_Setup.zip "https://github.com/SSLcom/eSignerCKA/releases/download/v1.0.7/SSL.COM-eSigner-CKA_1.0.7.zip"
          Expand-Archive -Force eSigner_CKA_Setup.zip
          Remove-Item eSigner_CKA_Setup.zip
          Move-Item -Destination "eSigner_CKA_Installer.exe" -Path "eSigner_CKA_*\*.exe"

      - name: Setup eSignerCKA in Silent Mode
        run: |
          New-Item -ItemType Directory -Force -Path $Env:INSTALL_DIR | Out-Null
          Start-Process ".\eSigner_CKA_Installer.exe" -ArgumentList '/CURRENTUSER /VERYSILENT /SUPPRESSMSGBOXES /DIR="'+$Env:INSTALL_DIR+'"' -Wait
          & "$Env:INSTALL_DIR/RegisterKSP.exe" | Out-Null
          & "$Env:INSTALL_DIR/eSignerCSP.Config.exe" | Out-Null

      - name: Configure eSignerCKA account
        shell: pwsh
        env:
          ES_USERNAME: ${{ secrets.ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
          ES_TOTP_SECRET: ${{ secrets.ES_TOTP_SECRET }}
        run: |
          $exe = Join-Path $Env:INSTALL_DIR 'eSignerCKATool.exe'
          & $exe config `
            -mode product `
            -user $Env:ES_USERNAME `
            -pass $Env:ES_PASSWORD `
            -totp $Env:ES_TOTP_SECRET `
            -key  $Env:MASTER_KEY_FILE `
            -r

      - name: Load certificate into CurrentUser store
        run: |
          & "$Env:INSTALL_DIR/eSignerCKATool.exe" unload
          & "$Env:INSTALL_DIR/eSignerCKATool.exe" load

      - name: Select code signing certificate
        shell: pwsh
        run: |
          $CodeSigningCert = Get-ChildItem Cert:\CurrentUser\My -CodeSigningCert | Where-Object { $_.Subject -match 'Life Sciences Foundation gUG' } | Select-Object -First 1
          if (-not $CodeSigningCert) { throw "Code signing cert not found." }
          "THUMBPRINT=$($CodeSigningCert.Thumbprint)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Resolve stable SignTool path
        id: signtool
        shell: pwsh
        run: |
          $base = 'C:\Program Files (x86)\Windows Kits\10\bin'
          $preferred = @('10.0.22621.0','10.0.22000.0','10.0.19041.0','10.0.17763.0','10.0.26100.0')
          $path = $null
          foreach ($v in $preferred) {
            $candidate = Join-Path $base "$v\x64\signtool.exe"
            if (Test-Path $candidate) { $path = $candidate; break }
          }
          if (-not $path) {
            $found = Get-ChildItem -Directory $base | Sort-Object Name -Descending | ForEach-Object { Join-Path $_.FullName 'x64\signtool.exe' } | Where-Object { Test-Path $_ } | Select-Object -First 1
            $path = $found
          }
          if (-not $path) { throw "SignTool not found." }
          "SIGNSDK=$path" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using signtool: $path"

      - name: Install WiX Toolset (for Insignia)
        run: choco install wixtoolset --version=3.14.0.6526 -y

      - name: Pre-sign diagnostics
        shell: pwsh
        run: |
          Get-FileHash "$Env:SIGNABLE_APP_FILE_PATH" -Algorithm SHA256
          $sig = Get-AuthenticodeSignature "$Env:SIGNABLE_APP_FILE_PATH"
          Write-Host "Pre-sign signature status: $($sig.Status)"

      - name: Sign bundle (append if already signed)
        shell: pwsh
        env:
          THUMBPRINT: ${{ env.THUMBPRINT }}
        run: |
          $file = "$Env:SIGNABLE_APP_FILE_PATH"
          $sig = Get-AuthenticodeSignature $file
          $args = @('sign','/debug','/fd','sha256','/tr','https://ts.ssl.com','/td','sha256','/sha1',"$Env:THUMBPRINT", "$file")
          if ($sig.Status -eq 'Valid') { $args = @('sign','/as','/debug','/fd','sha256','/tr','https://ts.ssl.com','/td','sha256','/sha1',"$Env:THUMBPRINT", "$file") }
          & "$Env:SIGNSDK" @args

      - name: Post-sign verification (signature and container)
        shell: pwsh
        run: |
          & "$Env:SIGNSDK" verify /pa /all /v "$Env:SIGNABLE_APP_FILE_PATH"
          # Validate attached container is intact
          $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe"
          if (-not (Test-Path $insignia)) { $insignia = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin\insignia.exe" }
          & "$insignia" -ib "$Env:SIGNABLE_APP_FILE_PATH" -o payload.cab
          if (-not (Test-Path 'payload.cab')) { throw "Attached container extraction failed after signing." }
          Remove-Item payload.cab

      - name: Upload signed setup
        uses: actions/upload-artifact@v5
        with:
          name: OSPSuite-Full.12.1.136
          path: OSPSuite-Full.12.1.136.exe

      - name: Upload eSignerCKA Logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v5
        with:
          name: eSignerCKA-Logs-APP
          path: C:\Users\runneradmin\AppData\Roaming\eSignerCKA\KSP